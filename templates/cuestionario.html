<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cuestionario CASM-83</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .option-group { background-color: #f8f9fa; border-radius: 8px; padding: 10px; }
        .form-check-label { cursor: pointer; font-weight: 500; }
        .text-option { font-size: 0.95rem; color: #495057; }
        .badge-option { font-size: 0.8rem; margin-bottom: 5px; display: inline-block; }
        /* Clase para ocultar p√°ginas */
        .page-hidden { display: none; }
    </style>
</head>
<body class="bg-light">

    <div class="container mt-4 mb-5">
        <h2 class="text-center text-primary mb-3">Cuestionario de Intereses</h2>
        
        <div class="progress mb-4" style="height: 25px;">
            <div id="progressBar" class="progress-bar bg-success progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
        </div>

        <form action="/resultados" method="POST" id="mainForm">
            <input type="hidden" name="genero" value="{{ genero }}">
            <input type="hidden" name="grado" value="{{ grado }}">

            <div id="questionsContainer">
                {% for p in preguntas %}
                <div class="card mb-4 shadow-sm border-0 question-card" data-index="{{ loop.index0 }}">
                    <div class="card-header bg-white border-bottom-0 pt-3">
                        <h5 class="fw-bold text-secondary">Pregunta {{ p.id }}</h5>
                    </div>
                    
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6 mb-2">
                                <div class="p-3 border rounded bg-white h-100">
                                    <span class="badge bg-primary badge-option">Opci√≥n A</span>
                                    <p class="m-0 text-option">{{ p.text_a }}</p>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="p-3 border rounded bg-white h-100">
                                    <span class="badge bg-danger badge-option">Opci√≥n B</span>
                                    <p class="m-0 text-option">{{ p.text_b }}</p>
                                </div>
                            </div>
                        </div>

                        <div class="option-group text-center">
                            <label class="mb-2 text-muted small text-uppercase fw-bold">Selecciona tu respuesta:</label>
                            <div class="d-flex justify-content-center flex-wrap gap-3">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="Pregunta_{{ p.id }}" value="1" id="p{{p.id}}_opt1">
                                    <label class="form-check-label text-primary" for="p{{p.id}}_opt1">Solo A</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="Pregunta_{{ p.id }}" value="2" id="p{{p.id}}_opt2">
                                    <label class="form-check-label text-danger" for="p{{p.id}}_opt2">Solo B</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="Pregunta_{{ p.id }}" value="3" id="p{{p.id}}_opt3">
                                    <label class="form-check-label text-success" for="p{{p.id}}_opt3">Ambas</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="Pregunta_{{ p.id }}" value="0" id="p{{p.id}}_opt0">
                                    <label class="form-check-label text-secondary" for="p{{p.id}}_opt0">Ninguna</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="d-flex justify-content-between mt-4">
                <button type="button" id="prevBtn" class="btn btn-secondary btn-lg" onclick="changePage(-1)" disabled>‚¨Ö Anterior</button>
                <p class="align-self-center text-muted fw-bold" id="pageIndicator">P√°gina 1</p>
                <button type="button" id="nextBtn" class="btn btn-primary btn-lg" onclick="changePage(1)">Siguiente ‚û°</button>
                <button type="submit" id="submitBtn" class="btn btn-success btn-lg page-hidden">Finalizar Test üèÅ</button>
            </div>
        </form>
    </div>

    <script>
        const questionsPerPage = 13;
        let currentPage = 1;
        
        // Seleccionamos todas las tarjetas de pregunta
        const questions = document.querySelectorAll('.question-card');
        const totalQuestions = questions.length;
        const totalPages = Math.ceil(totalQuestions / questionsPerPage);

        function showPage(page) {
            // Validar l√≠mites
            if (page < 1) page = 1;
            if (page > totalPages) page = totalPages;
            currentPage = page;

            // Calcular √≠ndices
            const start = (page - 1) * questionsPerPage;
            const end = start + questionsPerPage;

            // Mostrar/Ocultar preguntas
            questions.forEach((q, index) => {
                if (index >= start && index < end) {
                    q.classList.remove('page-hidden');
                    q.classList.remove('d-none'); // Bootstrap utility
                } else {
                    q.classList.add('page-hidden');
                    q.classList.add('d-none');
                }
            });

            // Actualizar botones
            document.getElementById('prevBtn').disabled = (page === 1);
            
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            const indicator = document.getElementById('pageIndicator');

            indicator.innerText = `P√°gina ${page} de ${totalPages}`;

            if (page === totalPages) {
                nextBtn.classList.add('page-hidden'); // Ocultar Siguiente
                submitBtn.classList.remove('page-hidden'); // Mostrar Finalizar
            } else {
                nextBtn.classList.remove('page-hidden');
                submitBtn.classList.add('page-hidden');
            }

            // Actualizar Barra de Progreso
            const progress = Math.round((page / totalPages) * 100);
            const bar = document.getElementById('progressBar');
            bar.style.width = progress + '%';
            bar.innerText = progress + '%';
            
            // Scroll hacia arriba suavemente
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function validatePage(page) {
            const start = (page - 1) * questionsPerPage;
            const end = start + questionsPerPage;
            let allAnswered = true;

            // Recorrer solo las preguntas de la p√°gina actual
            for (let i = start; i < end; i++) {
                if (i >= totalQuestions) break;
                
                // Buscar si hay alg√∫n radio chequeado en esta pregunta
                const radios = questions[i].querySelectorAll('input[type="radio"]');
                let answered = false;
                radios.forEach(r => { if(r.checked) answered = true; });

                if (!answered) {
                    allAnswered = false;
                    // Resaltar error visualmente
                    questions[i].classList.add('border-danger');
                    questions[i].classList.add('border-3');
                } else {
                    questions[i].classList.remove('border-danger');
                    questions[i].classList.remove('border-3');
                }
            }
            return allAnswered;
        }

        function changePage(direction) {
            // Si intenta avanzar, validamos primero
            if (direction === 1) {
                if (!validatePage(currentPage)) {
                    alert("‚ö†Ô∏è Por favor, responde todas las preguntas de esta p√°gina antes de continuar.");
                    return;
                }
            }
            showPage(currentPage + direction);
        }

        // Inicializar
        showPage(1);
    </script>

</body>
</html>